FROM debian:bullseye-slim

ENV DEBIAN_FRONTEND noninteractive

ARG JITSI_RELEASE=stable
ARG FREP_VERSION=1.3.11

COPY rootfs /

RUN apt-dpkg-wrap apt-get update && \
    apt-dpkg-wrap apt-get install -y apt-transport-https apt-utils ca-certificates gnupg wget && \
    wget -qO - https://download.jitsi.org/jitsi-key.gpg.key | gpg --dearmour > /etc/apt/trusted.gpg.d/jitsi.gpg && \
    wget -qO /usr/bin/frep https://github.com/subchen/frep/releases/download/v$FREP_VERSION/frep-$FREP_VERSION-linux-amd64 && \
    echo "deb https://download.jitsi.org $JITSI_RELEASE/" > /etc/apt/sources.list.d/jitsi.list && \
    echo "deb http://ftp.debian.org/debian bullseye-backports main" > /etc/apt/sources.list.d/backports.list && \
    apt-dpkg-wrap apt-get update && \
    apt-dpkg-wrap apt-get dist-upgrade -y && \
    apt-cleanup && \
    chmod +x /usr/bin/frep

RUN [ "$JITSI_RELEASE" = "unstable" ] && \
    apt-dpkg-wrap apt-get update && \
    apt-dpkg-wrap apt-get install -y jq procps curl vim iputils-ping net-tools && \
    apt-cleanup || \
    true

# supervisor installation &&
# create directory for child images to store configuration in
RUN apt-dpkg-wrap apt-get update && \
    apt-dpkg-wrap apt-get -y install supervisor && \
    mkdir -p /var/log/supervisor

# fix permissions for timezone initialization
RUN chgrp -R 0 /usr/share/zoneinfo && \
    chgrp 0 /etc && \
    chgrp 0 /etc/localtime && \
    chgrp 0 /etc/timezone && \
    chmod g=u /etc && \
    chmod g=u /etc/localtime && \
    chmod g=u /etc/timezone && \
    chmod -R g=u /usr/share/zoneinfo

CMD [ "supervisord",  "-c", "/etc/supervisor.conf" ]
ENTRYPOINT [ "/entrypoint" ]